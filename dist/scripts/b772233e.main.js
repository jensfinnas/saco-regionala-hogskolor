function renderTemplate(a,b){for(key in b){var c=b[key],d=new RegExp("{{\\s?"+key+"\\s?}}","g");a=a.replace(d,c)}return a}function extend(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}Array.prototype.filterBy=function(a,b){return this.filter(function(c){return c[a]==b})},Array.prototype.sumBy=function(a){return d3.sum(this.map(function(b){return b[a]}))};var charts=[{id:"follow-students-from-county",csv:"data/follow_students_from_county.csv",xLabels:["Gymnasieort","Studieort","Boendeort 10 år senare"],writers:{title:function(a){var b={home:a[0].home},c="Vad hände med studenterna från {{home}}?";return renderTemplate(c,b)},description:function(a){var b={total:a[0].total,home:a[0].home},c="Här har vi följt de {{ total }} gymnaiseelever från {{ home }} som mellan 2000 och 2002 började studera på högskola.";return renderTemplate(c,b)},conclusions:function(a){var b={total:a[0].total,home:a[0].home,studyHome:d3.sum(a.filter(function(a){return"study_home"==a.target_id}).map(function(a){return a.value})),liveHome:d3.sum(a.filter(function(a){return"live_home"==a.target_id}).map(function(a){return a.value}))};b.studyHomeShare=b.studyHome/b.total,b.studyAwayShare=1-b.studyHomeShare,b.liveHomeShare=b.liveHome/b.total;var c="<ul>";if(b.studyHomeShare>.5){var d=Math.round(10*b.studyHomeShare),e=Math.round(10*b.liveHomeShare);b.studyHomeRoundedText=numberToText(d),b.studyHomeRoundedTextCap=b.studyHomeRoundedText.capitalize(),b.liveHomeRoundedText=numberToText(e),b.liveAwayRoundedText=numberToText(10-e),c+="<li>{{ studyHomeRoundedTextCap }} av tio från {{ home}} började också studera i länet.</li>",c+=e>d?"<li>Efter tio år bodde {{ liveHomeRoundedText }} av tio kvar i {{ home }}.</li>":e==d?"<li>Tio år senare bodde ungefär lika många kvar i {{ home }}.</li>":"<li>Efter tio år bodde {{ liveAwayRoundedText }} av utanför länet.</li>"}else{var f=Math.round(10*b.studyAwayShare),e=Math.round(10*b.liveHomeShare);b.studyAwayRoundedText=numberToText(f),b.studyAwayRoundedTextCap=b.studyAwayRoundedText.capitalize(),b.liveHomeRoundedText=numberToText(e),c+="<li>{{ studyAwayRoundedTextCap }} av tio från {{ home }} började studera på i ett annat län.</li>",c+=e>10-f?"<li>Efter tio år bodde totalt {{ liveHomeRoundedText }} av tio i {{ home }} tack vare återflyttning.</li>":e==10-f?"<li>Tio år senare bodde ungefär lika många kvar i {{ home }}.</li>":"<li>Efter tio år bodde bara {{ liveHomeRoundedText }} kvar i {{ home }} på grund av fortsatt utflyttning.</li>"}return c+="</ul>",renderTemplate(c,b)},linkSentence:function(a){var b,c=a.target.id.split("_")[0],d={homeRegion:a.meta.home};if("study"==c){var e=a.target.id.split("_")[1];d.value=formatPercentText(a.value/a.meta.total),d.studyRegion="home"==e?"i "+d.homeRegion:"på annan ort",b="{{ value }} procent av alla högskolestudenter från {{ homeRegion }} började studera {{ studyRegion }}."}else if("live"==c){var e=a.source.id.split("_")[1],f=a.target.id.split("_")[1];d.value=formatPercentText(a.value/a.source.value),d.studyRegion="home"==e?"i "+d.homeRegion:"på annan ort",d.liveRegion="home"==f?"i "+d.homeRegion:"på annan ort",b="Av de studenter från {{ homeRegion }} som studerade {{ studyRegion }} ",b+=f==e&&"home"==f?"bodde {{ value }} procent kvar i länet efter 10 år.":"home"!=e&&"home"==f?"återvände {{ value }} procent till {{ homeRegion }}.":"home"==e&&"home"!=f?"flyttade {{ value }} procent till annan ort.":"bodde {{ value }} procent kvar utanför länet efter 10 år."}return renderTemplate(b,d)}}},{id:"follow-students-in-county",csv:"data/follow_students_in_county.csv",xLabels:["Hemort","Boendeort 10 år senare"],writers:{title:function(a){var b={home:a[0].home},c="Vart flyttade studenterna som började plugga i {{home}}?";return renderTemplate(c,b)},description:function(a){var b={total:a[0].total,home:a[0].home},c="Här har vi följt de {{ total }} gymnaiseelever som började studera på högskola i {{ home }} mellan 2000 och 2002.";return renderTemplate(c,b)},conclusions:function(a){var b={total:a[0].total,home:a[0].home,studyHome:a.filterBy("source_id","origin_home").sumBy("value"),studyAway:a.filterBy("source_id","origin_away").sumBy("value")},c="",d=Math.round(b.studyHome/b.total*10),e=numberToText(d);b.studyHomeRoundedTextCap=e.capitalize();var f=Math.round(b.studyAway/b.total*10),g=numberToText(f);return b.studyAwayRoundedTextCap=g.capitalize(),c+=b.studyHome>b.studyAway?"<li>{{ studyHomeRoundedTextCap }} av tio studenter i {{ home }} kom från det egna länet.</li>":"<li>{{ studyAwayRoundedTextCap }} av tio studenter i {{ home }} kom från ett annat län.</li>",renderTemplate(c,b)},linkSentence:function(a){var b,c=(a.target.id.split("_")[0],{home:a.meta.home,origin:a.source.name,live:a.target.name}),b="";return c.value=formatPercentText(a.value/a.source.value),b+=c.home==c.origin?c.home==c.live?"Av studenterna från {{ home }} som också studerade i länet bodde {{ value }} kvar 10 år senare.":"Av studenterna från {{ home }} som också studerade i länet hade {{ value }} flyttat 10 år senare.":c.home==c.live?"Av studenterna från andra län bodde {{ value }} kvar i {{ home }} 10 år senare.":"Av studenterna från andra län hade {{ value }} flyttat bort från efter 10 år.",renderTemplate(b,c)}}}];console.log("'Allo 'Allo!"),Sankey=function(){function a(a,b,c,d){var e=this,f={metaColumns:[],xLabels:[]};e.opts=extend(f,d),e.data=e.formatData(b),e.getLinkSentence=c,e.container=d3.select(a);var g=e.container[0][0].offsetWidth;e.chartContainer=e.container.append("div").attr("class","chart"),e.margin=m={top:10,right:5,bottom:40,left:5},e.width=g-m.left-m.right,e.height=.7*e.width,e.drawCanvas(),e.initChart(),e.sentenceContainer=e.container.append("div").attr("class","sentence")}return a.prototype.formatData=function(a){var b=this,c={nodes:[],links:[]},d=[];return a.forEach(function(a){var e={id:a.source_id,name:a.source_name,"class":a.source_class,meta:{}},f={id:a.target_id,name:a.target_name,"class":a.target_class,meta:{}},g={source:a.source_id,target:a.target_id,"class":a.target_class,value:+a.value,meta:{}};b.opts.metaColumns.forEach(function(b){g.meta[b]=a[b],e.meta[b]=a[b],f.meta[b]=a[b]}),d.push(e),d.push(f),c.links.push(g)}),c.nodes=d3.keys(d3.nest().key(function(a){return a.id}).map(d)),c.links.forEach(function(a,b){c.links[b].source=c.nodes.indexOf(c.links[b].source),c.links[b].target=c.nodes.indexOf(c.links[b].target)}),c.nodes.forEach(function(a,b){c.nodes[b]=d.filter(function(b){return b.id==a})[0]}),c},a.prototype.drawCanvas=function(){var a=this,b=a.width,c=a.height,d=a.margin;a.svg=a.chartContainer.append("svg").attr("width",b+d.left+d.right).attr("height",c+d.top+d.bottom),a.chart=a.svg.append("g").attr("transform","translate("+d.left+","+d.top+")")},a.prototype.initChart=function(){var a=this,b=d3.tip().attr("class","d3-tip").offset(function(b){return b.source.x<160&&b.target.x>a.width/2?[0,160]:[0,0]}).direction(function(b){return b.target.x<=a.width/2?"e":"w"}).html(a.getLinkSentence);a.chart.call(b);var c=d3.sankey().nodeWidth(36).nodePadding(3).size([a.width,a.height]),d=c.link();c.nodes(a.data.nodes).links(a.data.links).layout(32);var e=a.chart.append("g").selectAll(".link").data(a.data.links).enter();e.append("path").attr("class",function(a){return"link "+a["class"]}).attr("d",d).style("stroke-width",function(a){return Math.max(1,a.dy)}).sort(function(a,b){return b.dy-a.dy}).on("mouseover",b.show).on("mouseout",b.hide);var f=a.chart.append("g").selectAll(".node").data(a.data.nodes).enter().append("g").attr("class",function(a){return"node "+a["class"]}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});f.append("rect").attr("height",function(a){return a.dy}).attr("width",c.nodeWidth()).append("title").text(function(a){return a.name+"\n"+a.value}),f.append("text").attr("x",function(a){return-a.dy/2}).attr("y",function(a){return c.nodeWidth()/2}).attr("dy",".35em").attr("text-anchor","middle").attr("transform","rotate(-90)").attr("class","label").text(function(a){return a.name}).filter(function(a){var b=this.parentElement.getElementsByTagName("rect")[0],c=d3.select(this),d=+b.getAttribute("height"),e=this.offsetWidth;if(e>.9*d){var f=Math.round(d/e*c.text().length)-3;c.text(c.text().substring(0,f).trim()+"...")}}),a.chart.selectAll("text.x-label").data(a.opts.xLabels).enter().append("text").attr("y",a.height+5).attr("dy",".75em").attr("x",function(b,c){return c/(a.opts.xLabels.length-1)*a.width}).attr("text-anchor",function(b,c){return c<(a.opts.xLabels.length-1)/2?"start":c>(a.opts.xLabels.length-1)/2?"end":"middle"}).attr("class","x-label").text(function(a){return a})},a.prototype.updateSentence=function(a){var b=this;b.sentenceContainer.html(a)},a}(),formatPercent=d3.format("%"),formatPercentText=function(a){return formatPercent(a).replace("%"," procent")},numberToText=function(a){var b=["noll","ett","två","tre","fyra","fem","sex","sju","åtta","nio","tio"];return b[a]},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};